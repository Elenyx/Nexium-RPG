<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collection - Nexium RPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/collection.css">
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <div class="nav-container">
            <a href="/" class="nav-logo">NEXIUM</a>
            <ul class="nav-menu">
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/characters">All Characters</a></li>
                <li><a href="/auth/logout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <header class="page-header">
        <h1>üé¥ My Character Collection</h1>
        <p>Your personal anime character collection from the multiverse</p>
    </header>

    <div class="container">
        <!-- Filters and Search -->
        <section class="collection-controls">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search characters..." class="search-input">
                <button id="search-btn" class="search-btn">üîç</button>
            </div>

            <div class="filters">
                <select id="rarity-filter" class="filter-select">
                    <option value="">All Rarities</option>
                    <option value="COMMON">Common</option>
                    <option value="RARE">Rare</option>
                    <option value="EPIC">Epic</option>
                    <option value="LEGENDARY">Legendary</option>
                    <option value="MYTHIC">Mythic</option>
                </select>

                <select id="anime-filter" class="filter-select">
                    <option value="">All Anime</option>
                </select>

                <button id="sort-btn" class="sort-btn">üìä Sort by Level</button>
            </div>
        </section>

        <!-- Collection Stats -->
        <section class="collection-stats">
            <div class="stat-card">
                <h3>Total Characters</h3>
                <span class="stat-number" id="total-count">0</span>
            </div>
            <div class="stat-card">
                <h3>Legendary</h3>
                <span class="stat-number legendary" id="legendary-count">0</span>
            </div>
            <div class="stat-card">
                <h3>Mythic</h3>
                <span class="stat-number mythic" id="mythic-count">0</span>
            </div>
            <div class="stat-card">
                <h3>Collection Value</h3>
                <span class="stat-number" id="collection-value">0</span>
            </div>
        </section>

        <!-- Character Grid -->
        <section class="character-collection">
            <div id="character-grid" class="character-grid">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading your collection...</p>
                </div>
            </div>
        </section>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-content">
                <h2>üéØ Start Your Collection!</h2>
                <p>You haven't collected any characters yet. Join our Discord server and start summoning!</p>
                <a href="https://discord.com/invite/nexium" class="discord-btn" target="_blank">
                    <span class="discord-icon">üí¨</span>
                    Join Discord Server
                </a>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" id="close-modal">&times;</span>
            <div id="character-detail" class="character-detail">
                <!-- Character details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allCharacters = [];
        let filteredCharacters = [];
        let currentSort = 'level';

        // Load collection on page load
        document.addEventListener('DOMContentLoaded', loadCollection);

        async function loadCollection() {
            try {
                const response = await fetch('/api/user/collection');
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }

                allCharacters = await response.json();
                filteredCharacters = [...allCharacters];

                populateAnimeFilter();
                updateStats();
                renderCharacters();

                // Hide loading spinner
                document.querySelector('.loading-spinner').style.display = 'none';

            } catch (error) {
                console.error('Error loading collection:', error);
                document.getElementById('character-grid').innerHTML =
                    '<p class="error">Error loading collection. Please try again.</p>';
            }
        }

        function populateAnimeFilter() {
            const animeSet = new Set(allCharacters.map(char => char.anime));
            const animeFilter = document.getElementById('anime-filter');

            animeSet.forEach(anime => {
                const option = document.createElement('option');
                option.value = anime;
                option.textContent = anime;
                animeFilter.appendChild(option);
            });
        }

        function updateStats() {
            document.getElementById('total-count').textContent = allCharacters.length;
            document.getElementById('legendary-count').textContent =
                allCharacters.filter(char => char.rarity === 'LEGENDARY').length;
            document.getElementById('mythic-count').textContent =
                allCharacters.filter(char => char.rarity === 'MYTHIC').length;

            // Calculate collection value (simple calculation based on rarity and level)
            const value = allCharacters.reduce((sum, char) => {
                const rarityMultiplier = { COMMON: 1, RARE: 2, EPIC: 5, LEGENDARY: 10, MYTHIC: 25 };
                return sum + (char.level * (rarityMultiplier[char.rarity] || 1));
            }, 0);
            document.getElementById('collection-value').textContent = value.toLocaleString();
        }

        function renderCharacters() {
            const grid = document.getElementById('character-grid');
            const emptyState = document.getElementById('empty-state');

            if (filteredCharacters.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = filteredCharacters.map(character => `
                <div class="character-card" data-rarity="${character.rarity.toLowerCase()}"
                     data-anime="${character.anime}" onclick="showCharacterDetail('${character.id}')">
                    <div class="character-image">
                        <img src="${character.imageUrl}" alt="${character.name}" loading="lazy">
                        <div class="character-rarity-badge ${character.rarity.toLowerCase()}">
                            ${character.rarity}
                        </div>
                    </div>
                    <div class="character-info">
                        <h3 class="character-name">${character.name}</h3>
                        <p class="character-anime">${character.anime}</p>
                        <div class="character-stats">
                            <span class="stat">Lv. ${character.level}</span>
                            <span class="stat">‚öîÔ∏è ${character.attack}</span>
                            <span class="stat">üõ°Ô∏è ${character.defense}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterCharacters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const rarityFilter = document.getElementById('rarity-filter').value;
            const animeFilter = document.getElementById('anime-filter').value;

            filteredCharacters = allCharacters.filter(character => {
                const matchesSearch = character.name.toLowerCase().includes(searchTerm) ||
                                    character.anime.toLowerCase().includes(searchTerm);
                const matchesRarity = !rarityFilter || character.rarity === rarityFilter;
                const matchesAnime = !animeFilter || character.anime === animeFilter;

                return matchesSearch && matchesRarity && matchesAnime;
            });

            renderCharacters();
        }

        function sortCharacters() {
            filteredCharacters.sort((a, b) => {
                if (currentSort === 'level') {
                    return b.level - a.level;
                } else if (currentSort === 'name') {
                    return a.name.localeCompare(b.name);
                } else if (currentSort === 'rarity') {
                    const rarityOrder = { MYTHIC: 5, LEGENDARY: 4, EPIC: 3, RARE: 2, COMMON: 1 };
                    return rarityOrder[b.rarity] - rarityOrder[a.rarity];
                }
                return 0;
            });

            renderCharacters();
        }

        function showCharacterDetail(characterId) {
            const character = allCharacters.find(char => char.id === characterId);
            if (!character) return;

            const modal = document.getElementById('character-modal');
            const detail = document.getElementById('character-detail');

            detail.innerHTML = `
                <div class="character-detail-header">
                    <img src="${character.imageUrl}" alt="${character.name}" class="detail-image">
                    <div class="detail-info">
                        <h2>${character.name}</h2>
                        <p class="detail-anime">${character.anime}</p>
                        <span class="detail-rarity ${character.rarity.toLowerCase()}">${character.rarity}</span>
                    </div>
                </div>
                <div class="character-detail-stats">
                    <div class="stat-row">
                        <span>Level: ${character.level}</span>
                        <span>Experience: ${character.exp.toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span>‚öîÔ∏è Attack: ${character.attack}</span>
                        <span>üõ°Ô∏è Defense: ${character.defense}</span>
                        <span>üí® Speed: ${character.speed}</span>
                    </div>
                    <div class="stat-row">
                        <span>‚ù§Ô∏è Health: ${character.health}</span>
                    </div>
                </div>
                <div class="character-detail-description">
                    <h3>Description</h3>
                    <p>${character.description}</p>
                </div>
                <div class="character-detail-abilities">
                    <h3>Abilities</h3>
                    <ul>
                        ${character.abilities.map(ability => `<li>${ability}</li>`).join('')}
                    </ul>
                </div>
            `;

            modal.style.display = 'block';
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', filterCharacters);
        document.getElementById('search-btn').addEventListener('click', filterCharacters);
        document.getElementById('rarity-filter').addEventListener('change', filterCharacters);
        document.getElementById('anime-filter').addEventListener('change', filterCharacters);
        document.getElementById('sort-btn').addEventListener('click', () => {
            currentSort = currentSort === 'level' ? 'rarity' : currentSort === 'rarity' ? 'name' : 'level';
            document.getElementById('sort-btn').textContent = `üìä Sort by ${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`;
            sortCharacters();
        });

        // Modal close
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('character-modal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            const modal = document.getElementById('character-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
